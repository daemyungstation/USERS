<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="SmartLifeDAO">
	
	<resultMap id="emfMap" type="emfMap">
		<result property="TERMS" column="TERMS" javaType="java.lang.String" jdbcType="CLOB" />
	</resultMap>
	
    <select id="SmartLifeDAO.getUserRecord" parameterType="emfMap" resultType="emfMap">
		SELECT
			<!-- START:2020.04.21 추가 -->
		    DECODE(TBL3.RSLT_CD,'N','산출완료','S','전송완료','E','반영실패','F','반영성공','R','미송신') AS RSLT_NM,
		    TBL3.RSLT_CD,
		    TBL3.FILE_NO,
			<!-- END:2020.04.21 추가 -->
			TBL.ACCNT_NO,
			TBL.MEM_NO,
			TBL.MEM_NM,
			TBL.PROD_NM,
			TBL.CELL,
			DECODE( TBL.KSTBIT, '01', '접수', '02', '가입', '03', '해약', '행사' ) AS ACC_STAT,
			TBL.PAY_STATE,
			TBL.JOIN_DT,
			TO_CHAR ( TBL.REG_DM, 'YYYY-MM-DD' ) AS REG_DM,
			TBL.EVENT_DAY,
			TBL2.AUTH_CODE AS AUTH_CD,
			TBL2.PAY_DT AS AUTH_DT,
			TBL.B2B_EMPLE_CI AS B2B_EMPLE_CI,
			TO_NUMBER(REPLACE(( SELECT CD_NM FROM COM_CD WHERE GRP_CD = 'SS01' AND COM_CD = TBL.PROD_CD ), ',', NULL)) AS SDP_ALOW
		FROM
			(
		SELECT
			MPA.ACCNT_NO,
			MPA.MEM_NO,
			MPA.KSTBIT,
			MPA.PROD_CD,
			MB.MEM_NM,
			FN_PROD_NM ( MPA.PROD_CD ) AS PROD_NM,
			MB.CELL,
			NVL ( RESN_CL, '00' ) AS ACC_STAT,
			FN_YEN_CHE ( MPA.ACCNT_NO ) AS PAY_STATE,
			MPA.JOIN_DT,
			MPA.REG_DM,
			FN_EVENT_DAY ( MPA.ACCNT_NO ) AS EVENT_DAY,
			( SELECT MAX( NO ) FROM PAY_MNG WHERE ACCNT_NO = MPA.ACCNT_NO AND DEL_FG = 'N' ) AS TRUE_COUNT,
			PD.SECTION_THR,
			B2B_EMPLE_CI
		FROM
			MEM_PROD_ACCNT MPA
			INNER JOIN MEMBER MB ON MPA.MEM_NO = MB.MEM_NO
			AND MPA.DEL_FG = 'N'
			INNER JOIN PRODUCT PD ON MPA.PROD_CD = PD.PROD_CD
			LEFT OUTER JOIN RESCISSION RS ON MPA.ACCNT_NO = RS.ACCNT_NO
			AND RS.DEL_FG = 'N'
			) TBL
			LEFT OUTER JOIN (
		SELECT
			A.ACCNT_NO,
			PAY_DT,
			AUTH_CODE
		FROM
			RT_CARD_PAY_LOG A
			INNER JOIN MEM_PROD_ACCNT B ON A.ACCNT_NO = B.ACCNT_NO
		WHERE
			1 = 1
			AND TO_CHAR ( B.REG_DM, 'YYYYMMDD' ) BETWEEN '201901'
			AND '201902'
			AND RESULT_CODE = '00'
			AND PAY_NO = 1 UNION ALL
		SELECT
			RST.ACCNT_NO,
			(
		CASE

			WHEN PAY_KIND != '01' THEN
			'20' || SUBSTR( AUTH_DT, 0, 6 ) ELSE TO_CHAR ( TO_DATE ( AUTH_DT ), 'YYYYMMDD' )
		END
			) AS AUTH_DT,
			AUTH_CD
		FROM
			TB_MEMBER_WDRW_RESULT RST
			INNER JOIN LF_DMUSER.TB_MEMBER_WDRW_REQ REQ ON RST.ACCNT_NO = REQ.ACCNT_NO
			AND RST.REQ_DAY = REQ.REQ_DAY
			AND REQ.RESULT_KEY = RST.RESULT_KEY
		WHERE
			1 = 1
			AND REQ.PAY_MTHD = '06'
			AND RST.RESULT_CD = '3001'
			AND PAY_KIND != '03'
			AND REQ.REQ_PAY_NO = 1
			AND SUBSTR( RST.REQ_DAY, 0, 6 ) BETWEEN '201901'
			AND '201902'
			) TBL2 ON TBL.ACCNT_NO = TBL2.ACCNT_NO
			<!-- START:2020.04.21 추가 -->
			LEFT OUTER JOIN 
			(SELECT ACCNT_NO, RSLT_CD, FILE_NO FROM TB_SAMSUNG_MES_LIST WHERE FILE_NO IS NOT NULL) TBL3 	
			ON TBL.ACCNT_NO = TBL3.ACCNT_NO		
<!--  			
			LEFT OUTER JOIN (
		        SELECT B.FILE_NO, A.REG_MAN, A.ACCNT_NO, A.RSLT_CD
		        FROM TB_SAMSUNG_MES_LIST A LEFT OUTER JOIN TB_SAMSUNG_MES_MST B
		        ON A.REG_MAN = B.REG_MAN
			) TBL3 ON TBL.ACCNT_NO = TBL3.ACCNT_NO
-->			
			<!-- END:2020.04.21 추가 -->
		WHERE
			TBL.SECTION_THR = '0010'
			AND TO_CHAR ( TBL.REG_DM, 'YYYYMMDD' ) BETWEEN '201701' AND '203012'
			AND TBL.JOIN_DT BETWEEN #{startDate} AND #{endDate}
			AND TBL.TRUE_COUNT > 0
			AND TBL.ACC_STAT != 02
			AND TBL.B2B_EMPLE_CI = #{ci}
	</select>

	<select id="SmartLifeDAO.getUserRecordTotalCount" parameterType="emfMap" resultType="int">
		SELECT
			COUNT(*)
		FROM
			(
			SELECT
				TBL.ACCNT_NO,
				TBL.MEM_NO,
				TBL.MEM_NM,
				TBL.PROD_NM,
				TBL.CELL,
				TBL.ACC_STAT,
				TBL.PAY_STATE,
				TBL.JOIN_DT,
				TO_CHAR ( TBL.REG_DM, 'YYYY-MM-DD' ) AS REG_DM,
				TBL.EVENT_DAY,
				TBL2.AUTH_CODE AS AUTH_CD,
				TBL2.PAY_DT AS AUTH_DT,
				TBL.B2B_EMPLE_CI AS B2B_EMPLE_CI,
				( SELECT CD_NM FROM COM_CD WHERE GRP_CD = 'SS01' AND COM_CD = TBL.PROD_CD ) AS SDP_ALOW
			FROM
				(
			SELECT
				MPA.ACCNT_NO,
				MPA.MEM_NO,
				MPA.PROD_CD,
				MB.MEM_NM,
				FN_PROD_NM ( MPA.PROD_CD ) AS PROD_NM,
				MB.CELL,
				NVL ( RESN_CL, '00' ) AS ACC_STAT,
				FN_YEN_CHE ( MPA.ACCNT_NO ) AS PAY_STATE,
				MPA.JOIN_DT,
				MPA.REG_DM,
				FN_EVENT_DAY ( MPA.ACCNT_NO ) AS EVENT_DAY,
				( SELECT MAX( NO ) FROM PAY_MNG WHERE ACCNT_NO = MPA.ACCNT_NO AND DEL_FG = 'N' ) AS TRUE_COUNT,
				PD.SECTION_THR,
				B2B_EMPLE_CI
			FROM
				MEM_PROD_ACCNT MPA
				INNER JOIN MEMBER MB ON MPA.MEM_NO = MB.MEM_NO
				AND MPA.DEL_FG = 'N'
				INNER JOIN PRODUCT PD ON MPA.PROD_CD = PD.PROD_CD
				LEFT OUTER JOIN RESCISSION RS ON MPA.ACCNT_NO = RS.ACCNT_NO
				AND RS.DEL_FG = 'N'
				) TBL
				LEFT OUTER JOIN (
			SELECT
				A.ACCNT_NO,
				PAY_DT,
				AUTH_CODE
			FROM
				RT_CARD_PAY_LOG A
				INNER JOIN MEM_PROD_ACCNT B ON A.ACCNT_NO = B.ACCNT_NO
			WHERE
				1 = 1
				AND TO_CHAR ( B.REG_DM, 'YYYYMMDD' ) BETWEEN '201901'
				AND '201902'
				AND RESULT_CODE = '00'
				AND PAY_NO = 1 UNION ALL
			SELECT
				RST.ACCNT_NO,
				(
			CASE

				WHEN PAY_KIND != '01' THEN
				'20' || SUBSTR( AUTH_DT, 0, 6 ) ELSE TO_CHAR ( TO_DATE ( AUTH_DT ), 'YYYYMMDD' )
			END
				) AS AUTH_DT,
				AUTH_CD
			FROM
				TB_MEMBER_WDRW_RESULT RST
				INNER JOIN LF_DMUSER.TB_MEMBER_WDRW_REQ REQ ON RST.ACCNT_NO = REQ.ACCNT_NO
				AND RST.REQ_DAY = REQ.REQ_DAY
				AND REQ.RESULT_KEY = RST.RESULT_KEY
			WHERE
				1 = 1
				AND REQ.PAY_MTHD = '06'
				AND RST.RESULT_CD = '3001'
				AND PAY_KIND != '03'
				AND REQ.REQ_PAY_NO = 1
				AND SUBSTR( RST.REQ_DAY, 0, 6 ) BETWEEN '201901'
				AND '201902'
				) TBL2 ON TBL.ACCNT_NO = TBL2.ACCNT_NO
				<!-- 2020.04.21 추가 -->
				LEFT OUTER JOIN 
				(SELECT ACCNT_NO, RSLT_CD, FILE_NO FROM TB_SAMSUNG_MES_LIST WHERE FILE_NO IS NOT NULL) TBL3  	
				ON TBL.ACCNT_NO = TBL3.ACCNT_NO				
<!--  				
				LEFT OUTER JOIN (
			        SELECT B.FILE_NO, A.REG_MAN, A.ACCNT_NO, A.RSLT_CD
			        FROM TB_SAMSUNG_MES_LIST A LEFT OUTER JOIN TB_SAMSUNG_MES_MST B
			        ON A.REG_MAN = B.REG_MAN
				) TBL3 ON TBL.ACCNT_NO = TBL3.ACCNT_NO
-->				
				<!-- 2020.04.21 추가 -->
			WHERE
				TBL.SECTION_THR = '0010'
				AND TO_CHAR ( TBL.REG_DM, 'YYYYMMDD' ) BETWEEN '201811'
				AND '201812'
				AND TBL.JOIN_DT BETWEEN #{startDate} AND #{endDate}
				AND TRUE_COUNT > 0
				AND ACC_STAT != 02
			AND B2B_EMPLE_CI = #{ci}
			)
	</select>

</mapper>